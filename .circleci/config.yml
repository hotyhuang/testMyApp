version: 2.1

jobs:
  whoami:
    docker:
      - image: ubuntu:latest
    steps:
      - run:
          command: |
            echo Start pipeline
            whoami
            pwd
  install:
    docker:
      - image: cimg/node:17.0.1
    # working_directory: ~/circleci-demo-workflows
    working_directory: /tmp/my-output
    steps:
      - checkout # check out the code in the project directory
      - run:
          name: Install Dependencies
          command: |
            pwd
            npm install
      # - save_cache: # Caches dependencies with a cache key
      #     key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
      #     paths:
      #       - ~/circleci-demo-workflows
      - persist_to_workspace: # Persist the specified paths (workspace/echo-output)
      # into the workspace for use in downstream job. Must be an absolute path,
      # or relative path from working_directory. This is a directory on the container which is
      # taken to be the root directory of the workspace.
          root: /tmp
            # Must be relative path from root
          paths:
            - my-output
  list1:
    docker:
      - image: cimg/node:17.0.1
    # working_directory: ~/circleci-demo-workflows
    working_directory: /tmp/my-output
    steps:
      # - restore_cache: # Restores the cached dependency.
      #     key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
      - attach_workspace:
        # Must be absolute path or relative path from working_directory
          at: /tmp/my-output
      - run:
          name: list files
          command: |
            pwd
            npm run list
            node -v
  list2:
    docker:
      - image: ubuntu:latest
    steps:
      # - restore_cache: # Restores the cached dependency.
      #     key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          name: list files
          # working_directory: /home/circleci/circleci-demo-workflows
          working_directory: /tmp/my-output
          command: |
            pwd
            ls -al
#...
workflows:
  build_and_test: # name of your workflow
    jobs:
      - whoami
      - install:
          requires:
            - whoami
      - list1:
          requires:
           - install # wait for build1 job to complete successfully before starting
           # see circleci.com/docs/2.0/workflows/ for more examples.
      - list2:
          requires:
           - install # wait for build1 job to complete successfully before starting
           # run build2 and build3 concurrently to save time.